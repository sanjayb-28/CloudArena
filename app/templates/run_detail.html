{% extends "base.html" %}
{% block content %}
  <a href="/ui">← Back to dashboard</a>
  <section class="card">
    <h2>Run {{ run.run_id }}</h2>
    <p>
      Created: {{ run.created_at }}
      · Status:
      {% if run.status %}
        {% set status_value = run.status %}
        {% set status_class = status_value | lower | replace(' ', '-') %}
        <span class="status-badge status-{{ status_class }}">
          {% if status_class in ["queued", "running"] %}
            <span class="spinner"></span>
          {% endif %}
          {{ status_value | capitalize }}
        </span>
      {% else %}
        —
      {% endif %}
      {% if run.completed_at %}· Completed: {{ run.completed_at }}{% endif %}
      · Goals: {{ run.goals or "—" }}
    </p>

    <h3>Runbook Steps</h3>
    {% if runbook.get('steps') %}
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Technique</th>
            <th>Parameters</th>
          </tr>
        </thead>
        <tbody>
          {% for step in runbook.get('steps') %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ step.technique_id }}</td>
              <td><code>{{ step.params }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No steps recorded in this runbook.</p>
    {% endif %}
  </section>

  <section class="card">
    <div class="tab-header">
  <button type="button" class="tab-button" data-tab="summary" onclick="switchTab(event, 'summary')" aria-selected="true">Summary</button>
  <button type="button" class="tab-button" data-tab="timeline" onclick="switchTab(event, 'timeline')" aria-selected="false">Timeline</button>
    </div>

    <div id="summary-view" class="tab-panel">
      <div
        id="summary-panel"
        hx-get="/events/{{ run.run_id }}?view=summary"
        hx-trigger="load, every 5s, summary-refresh"
        hx-swap="innerHTML"
      >
        {% include "events_summary.html" %}
      </div>
    </div>

    <div id="timeline-view" class="tab-panel" hidden>
      <div
        id="timeline-panel"
        hx-get="/events/{{ run.run_id }}"
        hx-trigger="load, every 2s, timeline-refresh"
        hx-swap="innerHTML"
      >
        {% include "events_fragment.html" %}
      </div>
    </div>
  </section>

  <section class="card">
    <h3>Generate Report</h3>
    <form hx-post="/ui/runs/{{ run.run_id }}/reports" hx-target="#report-output" hx-swap="innerHTML">
      <button type="submit">Generate Markdown Report</button>
    </form>
    <div id="report-output" style="margin-top: 1rem;"></div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  function switchTab(event, tabName) {
    const buttons = event.currentTarget.parentElement.querySelectorAll('.tab-button');
    buttons.forEach(btn => btn.setAttribute('aria-selected', btn.dataset.tab === tabName ? 'true' : 'false'));

    const summaryView = document.getElementById('summary-view');
    const timelineView = document.getElementById('timeline-view');
    const summaryPanel = document.getElementById('summary-panel');
    const timelinePanel = document.getElementById('timeline-panel');

    if (tabName === 'summary') {
      summaryView.hidden = false;
      timelineView.hidden = true;
      if (window.htmx && summaryPanel) {
        window.htmx.trigger(summaryPanel, 'summary-refresh');
      }
    } else {
      summaryView.hidden = true;
      timelineView.hidden = false;
      if (window.htmx && timelinePanel) {
        window.htmx.trigger(timelinePanel, 'timeline-refresh');
      }
    }
  }
</script>
{% endblock %}
